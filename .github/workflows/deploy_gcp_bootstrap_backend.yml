name: 'GCP Terraform Backend Bootstrap'

on:
  # Allows you to run this workflow manually from the GitHub Actions tab
  workflow_dispatch:

# The job will use the Service Account key to authenticate and provision the GCS bucket.
jobs:
  bootstrap_gcs:
    name: 'GCS State Bucket Setup'
    runs-on: ubuntu-latest
    environment: production # Recommended practice for apply steps

    # Define the repository variables as environment variables for Terraform
    env:
      TF_WORKING_DIR: case_studies/StorySpark/src/infra/gcp/bootstrap_backend
      
      # GitHub Repository Variables (Set these in Settings > Secrets and variables > Actions > Variables)
      GCP_PROJECT_ID: ${{ vars.STORYSPARK_GCP_PROJECT_ID }}
      GCP_REGION: ${{ vars.STORYSPARK_GCP_REGION }}
      GCP_BUCKET_NAME: ${{ vars.STORYSPARK_GCP_TF_STATE_BUCKET }}
      
      # GitHub Repository Secret (Set this in Settings > Secrets and variables > Actions > Secrets)
      GCP_SA_KEY: ${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP and setup gcloud
        uses: google-github-actions/auth@v2
        with:
          # Use the Service Account Key JSON secret
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0 # Specify a recommended version

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        id: plan
        run: terraform plan \
          -var="project_id=${{ env.GCP_PROJECT_ID }}" \
          -var="region=${{ env.GCP_REGION }}" \
          -var="bucket_name=${{ env.GCP_BUCKET_NAME }}" \
          -out=tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}
