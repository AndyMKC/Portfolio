name: Build/Push/Deploy image for StorySpark

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (optional)'
        required: false
        default: ''

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

env:
  #ACR_NAME: storysparkacr
  #ACR_LOGIN_SERVER: storysparkacr.azurecr.io
  KEEP: 2
  TF_GOOGLE_DIR: case_studies/StorySpark/src/infra/gcp/main
  PROJECT_ID: storyspark-555555
  GCS_BUCKET: storyspark-555555-terraform-state
  TF_PLAN_FILE: storyspark.tfplan

  # --- GitHub Variables (used via 'vars.') ---
  GCP_PROJECT_ID: ${{ vars.STORYSPARK_GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.STORYSPARK_GCP_REGION }}
  GCP_ZONE: ${{ vars.STORYSPARK_GCP_ZONE }}
  GCP_TF_STATE_BUCKET: ${{ vars.STORYSPARK_GCP_TF_STATE_BUCKET }}

  # --- GitHub Secret (used via 'secrets.') ---
  # This variable holds the JSON content of the service account key for GCP
  GCP_TERRAFORM_SA_KEY_JSON: ${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}

jobs:
  terraform-plan: # This job will run on PRs and main branch pushes to generate the plan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read # Need read permission for checkout
      
    steps:
    # 1. Checkout the code
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Debug repo structure
      run: |
        echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
        ls -R $GITHUB_WORKSPACE

    # 2. Authenticate to GCP using the Service Account Key Secret
    - id: 'auth'
      name: 'Authenticate to Google Cloud via SA Key'
      uses: 'google-github-actions/auth@v2'
      with:
        # Pass the secret key content directly to the action
        credentials_json: ${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}

    # DEBUG TODO:
    # - name: Show active account and SA email
    #   run: |
    #     # show active account used by gcloud (if gcloud is installed)
    #     gcloud auth list --filter=status:ACTIVE --format="value(account)" || true

    #     # show project config
    #     gcloud config get-value project || true

    #     # print client_email from the JSON secret directly (no gcloud required)
    #     echo "SERVICE ACCOUNT FROM SECRET:"
    #     echo "${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}" | jq -r .client_email
    #   shell: bash

    - name: Show first 32 bytes of SA secret (console)
      shell: bash
      run: |
        # normalize CRLF and take first 32 bytes
        printf '%s' "${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}" | sed 's/\r$//' | head -c1024
    
    - name: Show effective identity
      run: |
        # show which account gcloud sees as active
        gcloud auth list --filter=status:ACTIVE --format="value(account)" || true

        # print the configured service_account value you supplied to the action
        echo "Configured impersonation/sa: sa-name@PROJECT.iam.gserviceaccount.com"
      shell: bash
      
    - name: Print SA email from secret
      run: |
        echo "${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}" | jq -r .client_email
      shell: bash
    # END DEBUG TODO:

    # 3. Set up Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.4.6

    # 4. Calculate the State Prefix based on the branch name
    - name: Calculate State Prefix
      id: prefix
      run: |
        # Get the branch name (e.g., 'main' or 'feature/new-api')
        BRANCH_NAME=$(echo ${{ github.ref_name }} | tr '/' '-') 
        
        # Use 'main/infra' for the main branch, otherwise use the branch name.
        if [ "$BRANCH_NAME" == "main" ]; then
          echo "tf_prefix=terraform/main/infra" >> $GITHUB_OUTPUT
        else
          echo "tf_prefix=terraform/$BRANCH_NAME/infra" >> $GITHUB_OUTPUT
        fi
      shell: bash
    
    # 5. Terraform Init - Configure GCS backend
    - name: Terraform Init
      id: init
      working-directory: ${{ github.workspace }}/${{ env.TF_GOOGLE_DIR }}
      run: |
        # Initialize Terraform and configure the GCS backend for state locking and persistence
        terraform init \
          -input=false \
          -reconfigure \
          -backend-config="bucket=${{ vars.STORYSPARK_GCP_TF_STATE_BUCKET }}" \
          -backend-config="prefix=${{ steps.prefix.outputs.tf_prefix }}"

    # 6. Terraform Plan & Save Artifact
    - name: Terraform Plan and Save
      id: plan
      working-directory: ${{ github.workspace }}/${{ env.TF_GOOGLE_DIR }}
      run: |
        # Generate the plan and save it to a file (tfplan) for the next job
        terraform plan \
          -input=false \
          -var="project_id=${{ vars.STORYSPARK_GCP_PROJECT_ID }}" \
          -var="location=${{ vars.STORYSPARK_GCP_LOCATION }}" \
          -var="region=${{ vars.STORYSPARK_GCP_REGION }}" \
          -var="zone=${{ vars.STORYSPARK_GCP_ZONE }}" \
          -var="tfstate_bucket_name=${{ vars.STORYSPARK_GCP_TF_STATE_BUCKET }}" \
          -lock-timeout=5m \
          -out=tfplan          
    
    # 7. Upload the generated plan file for the next job (Apply)
    - name: Upload Terraform Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-artifact
        path: ${{ env.TF_GOOGLE_DIR }}

  terraform-apply: # New job: Runs only on push to 'main' and requires 'plan' to succeed
    runs-on: ubuntu-latest
    
    # 1. Dependency: This job runs only after the 'plan' job successfully completes.
    needs: [terraform-plan]
    
    # 2. Condition: This job must only run the 'main' branch.
    if: github.ref == 'refs/heads/main' 
    
    permissions:
      contents: read # Need read permission for artifact download
      
    steps:
    # 1. Checkout the code (Needed for environment consistency/context, though plan artifact has the changes)
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. Authenticate to GCP using the Service Account Key Secret
    - id: 'auth'
      name: 'Authenticate to Google Cloud via SA Key'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ secrets.STORYSPARK_GCP_TERRAFORM_SA_KEY }}

    # 3. Set up Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.4.6
        
    # 4. Download the generated plan file
    - name: Download Terraform Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-artifact
        path: ${{ env.TF_GOOGLE_DIR }}
        
    # 5. Calculate the State Prefix based on the branch name
    - name: Calculate State Prefix
      id: prefix
      run: |
        # Get the branch name (e.g., 'main' or 'feature/new-api')
        BRANCH_NAME=$(echo ${{ github.ref_name }} | tr '/' '-') 
        
        # Use 'main/infra' for the main branch, otherwise use the branch name.
        if [ "$BRANCH_NAME" == "main" ]; then
          echo "tf_prefix=terraform/main/infra" >> $GITHUB_OUTPUT
        else
          echo "tf_prefix=terraform/$BRANCH_NAME/infra" >> $GITHUB_OUTPUT
        fi
      shell: bash
    
    # 6. Terraform Init (required before apply to ensure backend configuration)
    - name: Terraform Init
      id: init
      working-directory: ${{ github.workspace }}/${{ env.TF_GOOGLE_DIR }}
      run: |
        # Re-initialize to configure the GCS backend (state is needed for apply)
        terraform init \
          -input=false \
          -reconfigure \
          -backend-config="bucket=${{ vars.STORYSPARK_GCP_TF_STATE_BUCKET }}" \
          -backend-config="prefix=${{ steps.prefix.outputs.tf_prefix }}"
          
    # 7. Terraform Apply the saved plan
    - name: Terraform Apply
      working-directory: ${{ github.workspace }}/${{ env.TF_GOOGLE_DIR }}
      run: |
        # Execute the apply using the downloaded plan file
        terraform apply \
          -input=false \
          -auto-approve \
          -lock-timeout=5m \
          tfplan 

